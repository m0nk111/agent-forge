# Polling Service Configuration
# This file configures the autonomous GitHub issue polling service

# Polling interval in seconds (default: 300 = 5 minutes)
interval_seconds: 300

# GitHub configuration
github:
  # Bot username for polling and general operations (not coding/dev)
  # m0nk111-post handles issue detection, PR creation, comments
  # m0nk111-qwen-agent (codeagent) only handles git commits/pushes
  username: "m0nk111-post"
  
  # GitHub token (uses BOT_GITHUB_TOKEN or GITHUB_TOKEN env var if not specified)
  # token: "ghp_..."  # Uncomment and set if not using environment variable

# Repositories to monitor  
# Simple list format (dict format support coming soon)
repositories:
  - "m0nk111/agent-forge-test"  # TEST repo - active during test phase
  # Production repos - will be enabled later:
  # - "m0nk111/agent-forge"
  # - "m0nk111/stepperheightcontrol"
  # - "m0nk111/Mycodo"
  # - "m0nk111/caramba"

# Labels to watch for (issues must have at least one of these labels)
watch_labels:
  - "agent-ready"      # Manual trigger: add this label when issue is ready for agent
  - "auto-assign"      # Automatic: agent picks up immediately when assigned

# Maximum concurrent issues the agent can work on
max_concurrent_issues: 3

# Claim timeout in minutes (how long before another agent can claim an issue)
# Default: 60 minutes (1 hour)
# Set to 30 minutes for reasonable claim duration
claim_timeout_minutes: 30

# PR Monitoring & Auto-Review (NEW)
# Monitor pull requests and trigger reviewer agent with intelligent merge
pr_monitoring:
  enabled: true
  # Check for new PRs every N seconds (default: 600 = 10 minutes)
  interval_seconds: 600
  
  # Auto-review PRs from these users (whitelist)
  auto_review_users:
    - "m0nk111-post"       # Bot agent PRs
    - "m0nk111-coder1"     # Primary GPT-5 coder
    - "m0nk111-coder2"     # Primary GPT-4o coder
    - "m0nk111-qwen-agent" # Reserve/fallback Qwen coder
  
  # Skip auto-review for PRs from these trusted users
  skip_review_users:
    - "m0nk111"  # Admin account (trusted)
  
  # Only auto-review PRs with these labels (empty = all PRs)
  review_labels: []
  
  # Review configuration
  review_config:
    # Use LLM for deep code analysis (true = Ollama, false = static checks only)
    use_llm: true
    # LLM model for code review (requires Ollama)
    llm_model: "qwen2.5-coder:7b"
    # Bot account for posting reviews (use 'admin' for visibility)
    bot_account: "admin"
    # Enable full workflow (assign reviewers, add labels, assign PR)
    full_workflow: true
    # Post review comments to GitHub
    post_comments: true
  
  # Automated merge configuration
  merge_config:
    # Enable automated merging based on review results
    enabled: true
    # Auto-merge PRs with NO issues (0 critical, 0 warnings, 0 suggestions)
    auto_merge_if_approved: true
    # Merge PRs with minor suggestions (1-2 suggestions, no critical, <3 warnings)
    # RECOMMENDED: Set to true for faster iteration, creates follow-up issues
    merge_with_suggestions: true
    # Default merge method: merge, squash, or rebase
    merge_method: "squash"
    # Merge timeout: wait N seconds after review before merging (safety delay)
    merge_delay_seconds: 30
    
  # Advanced PR lifecycle management
  lifecycle_management:
    # Auto-convert to draft when critical issues or conflicts found
    auto_convert_to_draft: true
    # Add conflict resolution instructions as comment
    add_conflict_instructions: true
    # Create follow-up issues for merged PRs with suggestions
    create_followup_issues: true
    # Suggestion threshold for follow-up issue (suggestions count)
    followup_issue_threshold: 1
  
  # Reviewer selection strategy:
  # - "dedicated": Use dedicated reviewer_agent_id (single reviewer)
  # - "round-robin": Rotate between available code agents (avoid self-review)
  # - "all": All code agents review (except author)
  strategy: "round-robin"
  
  # Reviewer agent ID (used when strategy="dedicated")
  reviewer_agent_id: "reviewer-agent"
  
  # Available reviewer agents (used for round-robin/all strategies)
  # Each code agent can review, but won't review their own PRs
  # Priority order: reviewer > coder1 > coder2 > qwen (reserve)
  reviewer_agents:
    - agent_id: "reviewer-agent"
      username: "m0nk111-reviewer"
      llm_model: "gpt-5-chat-latest"  # Dedicated reviewer (always available)
    - agent_id: "coder-agent-1"
      username: "m0nk111-coder1"
      llm_model: "gpt-5-chat-latest"  # Primary GPT-5 coder (can review)
    - agent_id: "coder-agent-2"
      username: "m0nk111-coder2"
      llm_model: "gpt-4o"  # Primary GPT-4o coder (can review)
    - agent_id: "coder-agent-qwen"
      username: "m0nk111-qwen-agent"
      llm_model: "qwen-2.5-coder-32b"  # Reserve/fallback coder (can review)

# Issue Opener Integration (NEW)
# Automatically process new issues with issue-opener agent
issue_opener:
  enabled: true
  # Trigger issue-opener for issues with these labels
  trigger_labels:
    - "good first issue"
    - "enhancement"
    - "feature"
    - "agent-ready"  # TEST: Auto-trigger for agent-ready issues
  # Skip issues with these labels
  skip_labels:
    - "question"
    - "discussion"
    - "needs-design"
  # Issue opener agent ID
  agent_id: "issue-opener-agent"

# State file path (tracks processing issues)
state_file: "/opt/agent-forge/data/polling_state.json"

# Logging configuration
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR, CRITICAL
  file: "polling_service.log"
  format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"

# Advanced settings
advanced:
  # Retry configuration
  max_retries: 3
  retry_delay_seconds: 60
  
  # GitHub API rate limiting
  respect_rate_limits: true
  api_requests_per_minute: 60
  
  # Issue filters
  ignore_labels:
    - "wontfix"
    - "duplicate"
    - "invalid"
  
  # Minimum issue age before processing (seconds)
  # Prevents picking up issues that are still being edited
  min_issue_age_seconds: 60
